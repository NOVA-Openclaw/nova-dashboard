<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NOVA Dashboard ✨</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      color: #e0e0e0;
      padding: 2rem;
    }
    .container { max-width: 900px; margin: 0 auto; }
    header {
      text-align: center;
      margin-bottom: 2rem;
    }
    header h1 {
      font-size: 2.5rem;
      background: linear-gradient(90deg, #00d9ff, #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    header .subtitle { color: #888; margin-top: 0.5rem; }
    .section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #666;
      margin: 2rem 0 1rem 0;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .section-title .timestamp {
      font-size: 0.7rem;
      color: #555;
      text-transform: none;
      letter-spacing: normal;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
    }
    @media (max-width: 700px) {
      .grid { grid-template-columns: repeat(2, 1fr); }
    }
    .card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1.25rem;
      backdrop-filter: blur(10px);
    }
    .card h3 {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #888;
      margin-bottom: 0.5rem;
    }
    .card .value {
      font-size: 1.75rem;
      font-weight: 600;
      color: #00d9ff;
    }
    .card .value.small { font-size: 1.1rem; }
    .card .sub { font-size: 0.8rem; color: #666; margin-top: 0.25rem; }
    
    /* Staff cards */
    .staff-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1rem;
    }
    .staff-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1rem;
      backdrop-filter: blur(10px);
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      color: inherit;
      display: block;
    }
    .staff-card:hover {
      border-color: rgba(0, 217, 255, 0.4);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 217, 255, 0.15);
    }
    .staff-card.primary {
      border-color: rgba(168, 85, 247, 0.4);
      grid-column: span 2;
    }
    .staff-card.primary:hover {
      border-color: rgba(168, 85, 247, 0.6);
      box-shadow: 0 4px 12px rgba(168, 85, 247, 0.2);
    }
    .staff-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .staff-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00d9ff, #a855f7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
      color: #1a1a2e;
    }
    .staff-card.primary .staff-avatar {
      width: 48px;
      height: 48px;
      font-size: 1.1rem;
    }
    .staff-name {
      font-size: 1rem;
      font-weight: 600;
      color: #e0e0e0;
    }
    .staff-card.primary .staff-name {
      font-size: 1.2rem;
    }
    .staff-role {
      font-size: 0.7rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .staff-meta {
      display: flex;
      gap: 1rem;
      font-size: 0.75rem;
      color: #888;
    }
    .staff-meta .model {
      color: #666;
      font-family: monospace;
      font-size: 0.7rem;
    }
    .staff-status {
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .staff-status .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .staff-status .dot.online { background: #10b981; }
    .staff-status .dot.offline { background: #ef4444; }
    .staff-status .dot.ephemeral { background: #f59e0b; }
    @media (max-width: 700px) {
      .staff-card.primary { grid-column: span 1; }
    }
    .bar {
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      margin-top: 0.75rem;
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease;
    }
    .bar-fill.cyan { background: linear-gradient(90deg, #10b981, #00d9ff); }
    .bar-fill.purple { background: linear-gradient(90deg, #8b5cf6, #a855f7); }
    .bar-fill.orange { background: linear-gradient(90deg, #f59e0b, #ef4444); }
    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 0.5rem;
      animation: pulse 2s infinite;
    }
    .status-dot.green { background: #10b981; }
    .status-dot.red { background: #ef4444; animation: none; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .wide { grid-column: span 2; }
    @media (max-width: 700px) { .wide { grid-column: span 2; } }
    footer {
      text-align: center;
      margin-top: 2rem;
      color: #555;
      font-size: 0.85rem;
    }
    footer a { color: #00d9ff; text-decoration: none; }
    #error { color: #ef4444; display: none; margin-top: 1rem; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="avatar.png" alt="NOVA" style="width: 80px; height: 80px; border-radius: 50%; margin-bottom: 1rem; border: 2px solid rgba(0, 217, 255, 0.5);">
      <h1>✨ NOVA Dashboard</h1>
      <p class="subtitle">Neural Oracle, Velvet Attitude</p>
    </header>

    <!-- Agent Status -->
    <div class="section-title"><span>Agent Status</span><span class="timestamp" id="agent-updated"></span></div>
    <div class="grid">
      <div class="card">
        <h3>Status</h3>
        <div class="value"><span class="status-dot green" id="status-dot"></span><span id="gateway-status">—</span></div>
      </div>
      
      <div class="card">
        <h3>Model</h3>
        <div class="value small" id="model">—</div>
      </div>
      
      <div class="card">
        <h3>Compactions</h3>
        <div class="value" id="compactions">—</div>
        <div class="sub" id="last-compaction">Last: —</div>
      </div>
      
      <div class="card">
        <h3>Session</h3>
        <div class="value small" id="session">—</div>
      </div>
      
      <div class="card wide">
        <h3>Context Window</h3>
        <div class="value"><span id="context-percent">—</span>%</div>
        <div class="sub"><span id="context-used">—</span> / <span id="context-total">—</span> tokens</div>
        <div class="bar"><div class="bar-fill cyan" id="context-bar" style="width: 0%"></div></div>
      </div>
    </div>

    <!-- Staff Section -->
    <div class="section-title"><span>Staff</span><span class="timestamp" id="staff-updated"></span></div>
    <div class="staff-grid" id="staff-grid">
      <!-- Populated by JavaScript -->
      <div class="staff-card primary" style="opacity: 0.5;">
        <div class="staff-header">
          <div class="staff-avatar">?</div>
          <div>
            <div class="staff-name">Loading...</div>
            <div class="staff-role">—</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Anthropic API Stats - Current Month -->
    <div class="section-title"><span>Anthropic API — <span id="api-month">Month</span></span><span class="timestamp" id="anthropic-updated"></span></div>
    <div class="grid">
      <div class="card">
        <h3>MTD Spend</h3>
        <div class="value">$<span id="api-cost-mtd">—</span></div>
        <div class="sub">of $<span id="api-limit">—</span> limit</div>
      </div>
      
      <div class="card">
        <h3>Yesterday</h3>
        <div class="value">$<span id="api-yesterday">—</span></div>
        <div class="sub" id="api-yesterday-date">—</div>
      </div>
      
      <div class="card">
        <h3>Daily Avg</h3>
        <div class="value">$<span id="api-daily-avg">—</span></div>
        <div class="sub"><span id="api-days-elapsed">—</span> days</div>
      </div>
      
      <div class="card">
        <h3>Projected</h3>
        <div class="value" id="api-projected-container">$<span id="api-projected">—</span></div>
        <div class="sub" id="api-alert"></div>
      </div>
      
      <div class="card">
        <h3>All-Time</h3>
        <div class="value">$<span id="api-cost-total">—</span></div>
        <div class="sub">since <span id="api-since">Jan 30</span></div>
      </div>
      
      <div class="card">
        <h3>Cost/Hr (Active)</h3>
        <div class="value">$<span id="api-cph-working">—</span></div>
        <div class="sub"><span id="api-active-hours">—</span>h active</div>
      </div>
      
      <div class="card">
        <h3>Cost/Hr (Clock)</h3>
        <div class="value">$<span id="api-cph-clock">—</span></div>
        <div class="sub"><span id="api-clock-hours">—</span>h elapsed</div>
      </div>
      
      <div class="card">
        <h3>Cache Hit Rate</h3>
        <div class="value"><span id="api-cache-rate">—</span>%</div>
        <div class="sub">all-time</div>
      </div>
    </div>

    <!-- System Stats -->
    <div class="section-title"><span>System Stats</span><span class="timestamp" id="system-updated"></span></div>
    <div class="grid">
      <div class="card">
        <h3>Uptime</h3>
        <div class="value small" id="uptime">—</div>
      </div>
      
      <div class="card">
        <h3>Load Avg</h3>
        <div class="value small" id="load">—</div>
        <div class="sub"><span id="cpu-cores">—</span> cores</div>
      </div>
      
      <div class="card">
        <h3>Memory</h3>
        <div class="value"><span id="mem-percent">—</span>%</div>
        <div class="sub"><span id="mem-used">—</span> / <span id="mem-total">—</span> MB</div>
        <div class="bar"><div class="bar-fill purple" id="mem-bar" style="width: 0%"></div></div>
      </div>
      
      <div class="card">
        <h3>Disk</h3>
        <div class="value"><span id="disk-percent">—</span>%</div>
        <div class="sub"><span id="disk-used">—</span> / <span id="disk-total">—</span> GB</div>
        <div class="bar"><div class="bar-fill orange" id="disk-bar" style="width: 0%"></div></div>
      </div>
      
      <div class="card">
        <h3>Processes</h3>
        <div class="value" id="processes">—</div>
      </div>
      
      <div class="card">
        <h3>Network</h3>
        <div class="value small">↓<span id="net-rx">—</span></div>
        <div class="sub">↑<span id="net-tx">—</span></div>
      </div>
    </div>

    <p id="error">⚠️ Could not load status data</p>
    
    <footer>
      <a href="https://nova.dustintrammell.com">nova.dustintrammell.com</a>
    </footer>
  </div>
  
  <script>
    function formatBytes(bytes) {
      if (bytes >= 1e12) return (bytes / 1e12).toFixed(1) + ' TB';
      if (bytes >= 1e9) return (bytes / 1e9).toFixed(1) + ' GB';
      if (bytes >= 1e6) return (bytes / 1e6).toFixed(1) + ' MB';
      if (bytes >= 1e3) return (bytes / 1e3).toFixed(1) + ' KB';
      return bytes + ' B';
    }
    
    function timeAgo(date) {
      const mins = Math.round((Date.now() - date) / 60000);
      if (mins < 1) return 'just now';
      if (mins < 60) return mins + 'm ago';
      const hrs = Math.round(mins / 60);
      if (hrs < 24) return hrs + 'h ago';
      return Math.round(hrs / 24) + 'd ago';
    }

    async function loadStatus() {
      try {
        const res = await fetch('status.json?' + Date.now());
        const data = await res.json();
        
        document.getElementById('model').textContent = data.model || '—';
        document.getElementById('compactions').textContent = data.compactions ?? '—';
        document.getElementById('session').textContent = data.session || '—';
        document.getElementById('context-percent').textContent = data.context?.percent ?? '—';
        document.getElementById('context-used').textContent = (data.context?.used ?? 0).toLocaleString();
        document.getElementById('context-total').textContent = (data.context?.total ?? 0).toLocaleString();
        document.getElementById('context-bar').style.width = (data.context?.percent ?? 0) + '%';
        
        if (data.lastCompaction) {
          const lc = new Date(data.lastCompaction);
          document.getElementById('last-compaction').textContent = 'Last: ' + timeAgo(lc);
        }
        
        if (data.updated) {
          const d = new Date(data.updated);
          document.getElementById('agent-updated').textContent = 'Updated ' + timeAgo(d);
        }
      } catch (e) {
        console.error('Status load error:', e);
      }
    }

    async function loadSystem() {
      try {
        const res = await fetch('system.json?' + Date.now());
        const data = await res.json();
        
        // Gateway
        const running = data.gateway === 'running';
        document.getElementById('gateway-status').textContent = running ? 'Online' : 'Offline';
        document.getElementById('status-dot').className = 'status-dot ' + (running ? 'green' : 'red');
        
        // System stats
        document.getElementById('uptime').textContent = data.uptime?.human || '—';
        document.getElementById('load').textContent = data.load?.load1 || '—';
        document.getElementById('cpu-cores').textContent = data.cpu?.cores || '—';
        
        document.getElementById('mem-percent').textContent = data.memory?.percent ?? '—';
        document.getElementById('mem-used').textContent = (data.memory?.usedMB ?? 0).toLocaleString();
        document.getElementById('mem-total').textContent = (data.memory?.totalMB ?? 0).toLocaleString();
        document.getElementById('mem-bar').style.width = (data.memory?.percent ?? 0) + '%';
        
        document.getElementById('disk-percent').textContent = data.disk?.percent ?? '—';
        document.getElementById('disk-used').textContent = data.disk?.usedGB ?? '—';
        document.getElementById('disk-total').textContent = data.disk?.totalGB ?? '—';
        document.getElementById('disk-bar').style.width = (data.disk?.percent ?? 0) + '%';
        
        document.getElementById('processes').textContent = data.processes ?? '—';
        document.getElementById('net-rx').textContent = formatBytes(data.network?.rxBytes ?? 0);
        document.getElementById('net-tx').textContent = formatBytes(data.network?.txBytes ?? 0);
        
        if (data.updated) {
          const d = new Date(data.updated);
          document.getElementById('system-updated').textContent = 'Updated ' + timeAgo(d);
        }
      } catch (e) {
        document.getElementById('error').style.display = 'block';
        console.error('System load error:', e);
      }
    }
    
    async function loadAnthropic() {
      try {
        const res = await fetch('anthropic.json?' + Date.now());
        const data = await res.json();
        
        // Current month stats
        const cm = data.currentMonth || {};
        document.getElementById('api-month').textContent = cm.month ? new Date(cm.month + '-01').toLocaleString('en-US', {month: 'short', year: 'numeric'}) : 'Month';
        document.getElementById('api-cost-mtd').textContent = cm.spend?.toFixed(2) ?? '—';
        document.getElementById('api-limit').textContent = cm.limit?.toLocaleString() ?? '—';
        // Yesterday's stats
        const yd = data.yesterday || {};
        document.getElementById('api-yesterday').textContent = yd.costDollars?.toFixed(2) ?? '—';
        document.getElementById('api-yesterday-date').textContent = yd.date ? new Date(yd.date + 'T00:00:00').toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) : '—';
        
        // Daily average
        document.getElementById('api-daily-avg').textContent = cm.avgDailySpend?.toFixed(2) ?? '—';
        document.getElementById('api-days-elapsed').textContent = cm.daysElapsed ?? '—';
        document.getElementById('api-projected').textContent = cm.projectedMonthly?.toLocaleString() ?? '—';
        
        // Alert styling if over budget
        const projContainer = document.getElementById('api-projected-container');
        const alertEl = document.getElementById('api-alert');
        if (data.alerts?.projectedOverLimit) {
          projContainer.style.color = '#ff6b6b';
          const limitStr = cm.limit ? `$${cm.limit.toLocaleString()}` : 'limit';
          alertEl.textContent = `⚠️ Over ${limitStr}!`;
          alertEl.style.color = '#ff6b6b';
        } else {
          projContainer.style.color = '';
          alertEl.textContent = '';
        }
        
        // All-time stats
        document.getElementById('api-cost-total').textContent = data.allTime?.totalSpend?.toFixed(2) ?? '—';
        document.getElementById('api-since').textContent = data.allTime?.since ?? 'Jan 30';
        
        // Cost per hour
        const cph = data.costPerHour || {};
        document.getElementById('api-cph-working').textContent = cph.working?.toFixed(2) ?? '—';
        document.getElementById('api-active-hours').textContent = cph.activeHoursMonth?.toFixed(1) ?? '—';
        document.getElementById('api-cph-clock').textContent = cph.wallClock?.toFixed(2) ?? '—';
        document.getElementById('api-clock-hours').textContent = cph.wallClockHoursMonth ?? '—';
        
        // Cache hit rate
        document.getElementById('api-cache-rate').textContent = data.allTime?.cacheHitRate?.toFixed(1) ?? '—';
        
        if (data.updated) {
          const d = new Date(data.updated);
          document.getElementById('anthropic-updated').textContent = 'Updated ' + timeAgo(d);
        }
      } catch (e) {
        console.error('Anthropic load error:', e);
      }
    }

    async function loadStaff() {
      try {
        const res = await fetch('staff.json?' + Date.now());
        const data = await res.json();
        
        const grid = document.getElementById('staff-grid');
        grid.innerHTML = '';
        
        // Render Newhart (graduated instance) first if online
        if (data.newhart) {
          const nh = data.newhart;
          const card = document.createElement('a');
          card.className = 'staff-card primary';
          card.href = nh.dashboardUrl || '#';
          if (!nh.dashboardUrl) card.style.cursor = 'default';
          card.innerHTML = `
            <div class="staff-header">
              <div class="staff-avatar">NH</div>
              <div>
                <div class="staff-name">Newhart</div>
                <div class="staff-role">NHR Agent • Full Instance</div>
              </div>
            </div>
            <div class="staff-meta">
              <div class="staff-status">
                <span class="dot ${nh.status === 'online' ? 'online' : 'offline'}"></span>
                ${nh.status === 'online' ? 'Online' : 'Offline'}
              </div>
              <div class="model">:${nh.port}</div>
            </div>
          `;
          grid.appendChild(card);
        }
        
        // Render sub-agents
        const agents = data.agents || [];
        agents.forEach(agent => {
          // Skip nova-main (that's me) and nhr-agent (Newhart shown above)
          if (agent.name === 'nova-main' || agent.name === 'nhr-agent') return;
          
          const card = document.createElement('a');
          card.className = 'staff-card';
          card.href = `staff/${agent.name}.html`;
          card.onclick = (e) => { e.preventDefault(); /* TODO: detail view */ };
          
          const initials = (agent.nickname || agent.name).slice(0, 2).toUpperCase();
          const statusClass = agent.persistent ? 'online' : 'ephemeral';
          const statusText = agent.persistent ? 'Persistent' : 'On-demand';
          const modelShort = (agent.model || '').split('/').pop().replace('claude-', '').replace('gemini-', 'gem-');
          
          card.innerHTML = `
            <div class="staff-header">
              <div class="staff-avatar">${initials}</div>
              <div>
                <div class="staff-name">${agent.nickname || agent.name}</div>
                <div class="staff-role">${agent.role}</div>
              </div>
            </div>
            <div class="staff-meta">
              <div class="staff-status">
                <span class="dot ${statusClass}"></span>
                ${statusText}
              </div>
              <div class="model">${modelShort}</div>
            </div>
          `;
          grid.appendChild(card);
        });
        
        if (data.updated) {
          const d = new Date(data.updated);
          document.getElementById('staff-updated').textContent = 'Updated ' + timeAgo(d);
        }
      } catch (e) {
        console.error('Staff load error:', e);
      }
    }

    loadStatus();
    loadSystem();
    loadAnthropic();
    loadStaff();
    
    // Auto-refresh every 5 minutes (matches cron update interval)
    setInterval(() => {
      document.querySelectorAll('.timestamp').forEach(el => el.style.opacity = '0.5');
      setTimeout(() => {
        loadStatus();
        loadSystem();
        loadAnthropic();
        loadStaff();
        document.querySelectorAll('.timestamp').forEach(el => el.style.opacity = '1');
      }, 500);
    }, 300000);
  </script>
</body>
</html>
